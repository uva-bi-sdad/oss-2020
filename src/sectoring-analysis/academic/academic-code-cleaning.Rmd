---
title: "Academic Counts on GitHub"
author: "Morgan Klutzke"
date: "06/11/2020"
output: html_document
---

```{r packages, results="hide"}
rm(list = ls())

# load packages 
for (pkg in c("tidyverse", "igraph", "visNetwork", "data.table", "R.utils", 
              "RPostgreSQL", "cowplot", "maditr", "stringr", "stringi", "gridExtra")) {library(pkg, character.only = TRUE)}
```

```{r loading_data}
# connect to postgresql to get our data
conn <- dbConnect(drv = PostgreSQL(), 
                  dbname = "sdad", 
                  host = "10.250.124.195", 
                  port = 5432, 
                  user = Sys.getenv("db_userid"), 
                  password = Sys.getenv("db_pwd"))

# query the users_gh data from github data 
users_gh <- dbGetQuery(conn, "SELECT login, email, company
                              FROM gh.ctrs_extra")

institutions_hipolabs <- dbGetQuery(conn, "SELECT institution, country, domains FROM hipolabs.universities")

# disconnect from postgresql database 
dbDisconnect(conn)
```

First, cleaning hipolabs data before comparing it with github users.

```{r clean_hipolabs}
institutions_hipolabs <- institutions_hipolabs %>% 
  as.data.table() %>% 
  # convert to lower case
  dt_mutate(institution = str_to_lower(institution)) %>%
  # remove duplicates
  distinct() %>%
  # add category for students
  add_row(institution = "misc. student") %>%
  # add academic/research organizations present in users_gh but not in hipo labs data
  add_row(institution = "university of tokyo", country = "Japan", domains = "u-tokyo.ac.jp") %>%
  add_row(institution = "aalto university", country = "Finland", domains = "aalto.fi") %>%
  add_row(institution = "international institute of information technology, hyderabad", country = "India", domains = "iiit.ac.in") %>%
  #add_row(institution = "broad institute", country = "United States", domains = "broadinstitute.org") %>%
  #add_row(institution = "cern", country = "Switzerland", domains = "cern.ch") %>%
  #add_row(institution = "inria", country = "France", domains = "inria.fr") %>%
  #add_row(institution = "cnrs", country = "France", domains = "cnrs.fr") %>%
  add_row(institution = "space telescope science institute", country = "United States", domains = "stsci.edu") %>%
  #add_row(institution = "wellcome trust sanger institute", country = "United Kingdom", domains = "sanger.ac.uk") %>%
  add_row(institution = "hasso plattner institute", country = "Germany", domains = "hpi.de") %>%
  dt_mutate(institution = if_else(institution == "xi'an university of electronic science and technology", "xidian university", institution))
```

Looking at the total numbers before any recoding.

```{r initial_counts}
length(users_gh$company) 
# 2,143,407 total entries 
# note: there are actually 2,435,698 total users

valid_company_codes <- users_gh %>% drop_na(company) 
length(valid_company_codes$company)
# 422517 users with some company_code information 
length(valid_company_codes$company) / length(users_gh$company)
# putting us at 19.7124% that are identifiable for now 

# organize by company
orgs_initial <- users_gh %>% 
  drop_na(company) %>% 
  dt_mutate(organization = str_to_lower(company)) %>% 
  group_by(organization) %>% count() %>% arrange(-n)

# compare with hipo labs dataset
initial_overlap <- semi_join(orgs_initial, institutions_hipolabs, by = c("organization" = "institution"))
sum(initial_overlap[,"n"])
# 16,677 identified users from academic institutions
```

Recoding the companies in users_gh, using string matching to catch name variations.

```{r regex_recode}
orgs_clean <- users_gh %>%
  # remove all na's 
  drop_na(company) %>% 
  # convert to lower case 
  dt_mutate(organization = str_to_lower(company)) %>%
  # remove @ from start of names 
  dt_mutate(organization = str_replace_all(organization, "@", " ")) %>% 
  # remove uninformative words "inc." and "the"
  dt_mutate(organization = str_replace_all(organization, "\\b(, inc\\.|, inc| inc\\.| inc|\\.$)\\b", "")) %>%
  dt_mutate(organization = str_replace_all(organization, "\\b(the )\\b", "")) %>%
  # expand abbreviations "univ." and "iit"
  dt_mutate(organization = str_replace_all(organization, "\\b(univ\\.|univ)\\b", "university")) %>%
  dt_mutate(organization = str_replace_all(organization, "\\b(iit)\\b", "indian institute of technology,")) %>%
  dt_mutate(organization = str_trim(organization)) %>% 
  # classifying students
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(student)\\b"), 
                              yes = "misc. student", no = organization)) %>%
  # universities and research institutes 
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(duke university|duke|duke university libraries|dukeuniversity)\\b"), 
                              yes = "duke university", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
  pattern = "\\b(?i)(stanford university|stanford|stanfordmlgroup|stanfordvl|stanfordgeospatialcenter|stanfordhci|stanfordjournalism|stanfordmsl|stanfordnlp)\\b"), 
                              yes = "stanford university", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(massachusetts institute of technology|mit|mitmedialab|mit media lab)\\b"), 
                              yes = "massachusetts institute of technology", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(harvard medical school|harvard|harvard university|harvardagileroboticslab|harvardnlp|harvardx)\\b"), 
                              yes = "harvard university", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(^princeton university|princeton university$|princetonuniversity|princeton)\\b"), 
                              yes = "princeton university", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
  pattern = "\\b(?i)(^columbia university|columbia university$|barnard college|columbia-university)\\b"), 
                              yes = "columbia university", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
  pattern = "\\b(?i)(^northeastern university|northeastern university$|northeastern)\\b"), 
                              yes = "northeastern university", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
  pattern = "\\b(?i)(^northwestern university|northwestern university$|northwestern)\\b"), 
                              yes = "northwestern university", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
  pattern = "\\b(?i)(^cornell university|cornell university$|northwestern|^cornell tech|cornell tech$|cornelltech|^weill cornell|weill cornell$|weill cornell medicine$|cornell|cornell lab of ornithology|cornell-dti|cornell-rpal|cornell asl|weillcornell nygenome|cornell cs|cornell unveristy|cs, cornell)\\b"), 
                              yes = "cornell university", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
  pattern = "\\b(?i)(carnegie mellon|carnegie mellon university|carnegie mellon university software engineering institute|carnegie mellon university, silicon valley|cmu)\\b"), 
                              yes = "carnegie mellon university", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(john hopkins|john hopkins university|johns hopkins university applied physics laboratory)\\b"), 
                              yes = "john hopkins university", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(penn|upenn|pennlabs|university of pennsylvania|the university of pennsylvania|penn medicine)\\b"), 
                              yes = "university of pennsylvania", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
  pattern = "\\b(?i)(university of washington|university of washington(?! state)|univerisity of washington|univeristy of washington|universityofwashington|univesity of washington)\\b"),
                              yes = "university of washington", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization,
                              pattern = "\\b(?i)(university of california, san francisco|uc san francisco|university of california san francisco|ucsf)\\b"),
                              yes = "university of california, san francisco", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization,
                              pattern = "\\b(?i)(university of california santa barbara|uc santa barbara|ucsb)\\b"),
                              yes = "university of california, santa barbara", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization,
                              pattern = "\\b(?i)(university of california irvine|university of california, irvine|uc irvine)\\b"),
                              yes = "university of california, irvine", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization,
                              pattern = "\\b(?i)(university of california davis|university of california, davis|uc davis)\\b"),
                              yes = "university of california, davis", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization,
                              pattern = "\\b(?i)(ucla|university of california los angeles|university of california, los angeles)\\b"),
                              yes = "university of california, los angeles", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization,
                              pattern = "\\b(?i)(university of california berkeley|uc berkeley|university of california, berkeley)\\b"),
                              yes = "university of california, berkeley", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization,
                              pattern = "\\b(?i)(university of california, san diego|university of california san diego|ucsd|uc san diego)\\b"),
                              yes = "university of california, san diego", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(^california state|california state$|california state university$|^california polytechnic|california polytechnic$)\\b"), 
                              yes = "california state university system", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(^georgia institute of technology|^georgia tech|georgia institute of technology$|georgia tech$)\\b"), 
                              yes = "georgia institute of technology", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(university of british columbia|ubc)\\b"), 
                              yes = "university of british columbia", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(indiana university|indiana university bloomington|indiana university, bloomington)\\b"), 
                              yes = "indiana university", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(university of texas at austin|university of texas|the university of texas at austin)\\b"), 
                              yes = "university of texas at austin", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(^texas a&m|^texas a & m|texas a&m university)\\b"), 
                              yes = "texas a&m university - college station", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(university of college london|ucl|university college london)\\b"), 
                              yes = "university college london, university of london", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(new york university|nyu|nyulibraries|nyueserv|itpnyu)\\b"), 
                              yes = "new york university", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(penn state|penn state university|pennsylvania state university|the pennsylvania state university|pennstate)\\b"), 
                              yes = "pennsylvania state university", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
  pattern = "\\b(?i)(fred hutchinson cancer research center|fredhutch|fred hutch|fred hutchinson|fred hutchinson center|fred hutch cancer research center)\\b"), 
                              yes = "fred hutchinson cancer research center", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(shanghai jiao tong university|sjtu|jiao tong university|jiao tong)\\b"), 
                              yes = "shanghai jiaotong university", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(^tsinghua|tsinghua$|tsinghua university$|tsinghua univ$|tsinghua unviersity|tsinghuauniversity|tsinghua_university|tsinghuau)\\b"), 
                              yes = "tsinghua university", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(^university of michigan|university of michigan$|^the university of michigan|university of michigan, ann arbor)\\b"), 
                              yes = "university of michigan - ann arbor", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(^university of virginia|university of virginia$|^uva|uva$)\\b"), 
                              yes = "university of virginia, charlottesville", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(^virginia tech|virginia tech$|virginia tech university$|^Virginia Polytechnic)\\b"), 
                              yes = "virginia polytechnic institute and state university", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(^university of tokyo|^the university of tokyo|university of tokyo$)\\b"), 
                              yes = "university of tokyo", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(^university of waterloo|^the university of waterloo|university of waterloo$)\\b"), 
                              yes = "university of waterloo", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(^zhejiang|zhejiang university$|zju)\\b"), 
                              yes = "zhejiang university", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(^university of toronto|university of toronto$)\\b"), 
                              yes = "university of toronto", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(^imperial college london|imperial college london$)\\b"), 
                              yes = "imperial college london", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(^university of cambridge|university of cambridge$|^cambridge university|cambridge university$)\\b"), 
                              yes = "university of cambridge", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(^university of oxford|university of oxford$|^oxford university|oxford university$|^the university of oxford|^university of oxford,)\\b"), 
                              yes = "university of oxford", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(^peking university|peking university$|^peking university,)\\b"), 
                              yes = "peking university", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(^university of southern california|university of southern california$|^university of southern california,|usc)\\b"), 
                              yes = "university of southern california", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(^nanjing university|^nanjing univ|nanjing university$|^nanjing university,|nju)\\b"), 
                              yes = "nanjing university", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(^university of edinburgh|university of edinburgh$|^the university of edinburgh)\\b"), 
                              yes = "university of edinburgh", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(^purdue university|^purdue university,|purdue university$|department of statistics,purdue university|purdue univeristy)\\b"), 
                              yes = "purdue university", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(^university of florida|^university of florida,|university of florida$|universityofflorida)\\b"), 
                              yes = "university of florida", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(^university of chicago|^university of chicago,|^the university of chicago|university of chicago$|^uchicago|uchicago$|^u of chicago|u of chicago$)\\b"), 
                              yes = "university of chicago", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(university of illinois at chicago|university of illinois chicago|university of illinois, chicago)\\b"), 
                              yes = "university of illinois at chicago", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(university of illinois at springfield|university of illinois springfield|university of illinois, springfield)\\b"), 
                              yes = "university of illinois at springfield", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(university of illinois|university of illinois at urbana-champaign|university of illinois urbana-champaign|university of illinois, urbana-champaign|university of illinois at urbana champaign|uiuc)\\b"), 
                              yes = "university of illinois at urbana-champaign", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(^national university of singapore|^national university of singapore,|national university of singapore$)\\b"), 
                              yes = "national university of singapore", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(^fudan|fudan university$|fudan university)\\b"), 
                              yes = "fudan university", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(^boston university|boston university$)\\b"), 
                              yes = "boston university", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(^arizona state|^arizona state,|arizona state university$|arizona state$)\\b"), 
                              yes = "arizona state university", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(^mcgill|mcgill university$|mcgill$)\\b"), 
                              yes = "mcgill university", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(^oregon state|^oregon state,|oregon state university$|oregon state$)\\b"), 
                              yes = "oregon state university", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(^stony brook|stony brook university$|stony brook$|^state university of new york)\\b"), 
                              yes = "state university of new york system", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(^university of minnesota|university of minnesota$|^university of minnesota,)\\b"), 
                              yes = "university of minnesota", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(sun yat-sen university|(?=.*sun yat-sen)(?=.*guangzhou).*|sysu|zhongda)\\b"), 
                              yes = "zhongshan university", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(nsysu|(?=.*sun yat-sen)(?=.*taiwan).*|national sun yat-sen)\\b"), 
                              yes = "national sun yat-sen university", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(^university of alberta|university of alberta$|^university of alberta,)\\b"), 
                              yes = "university of alberta", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(^university of wisconsin-madison|^university of wisconsin|university of wisconsin$|university of wisconsin-madison$|university of wisconsinmadison|^university of wisconsin,|^uw-madison|uw-madison$)\\b"), 
                              yes = "university of wisconsin - madison", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(^rwth aachen university|rheinisch westfalische technische hochschule aachen)\\b"), 
                              yes = "rheinisch westfälische technische hochschule aachen", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(politecnico di milano|^polytechnic institute of milan)\\b"),
                              yes = "polytechnic institute of milan", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(delft university of technology|^tu delft)\\b"),
                              yes = "delft university of technology", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(buaa|beihang university)\\b"),
                              yes = "beijing university of aeronautics and astronautics", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(tu dresden|technische universitat dresden)\\b"),
                              yes = "technische universität dresden", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(university of colorado|university of colorado boulder|university of colorado, boulder|university of colorado - boulder|university of colorado-boulder)\\b"),
                              yes = "university of colorado at boulder", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(katholieke universiteit leuven|ku leuven)\\b"),
                              yes = "katholieke universiteit leuven", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(eth zurich|eidgenössische technische hochschule zürich|eth zürich|swiss federal institute of technology in zurich|politecnico federale di zurigo|école polytechnique fédérale de zurich|eth zrich)\\b"),
                              yes = "ethz - eth zurich", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(university of maryland|university of maryland$|university of maryland - college park)\\b"),
                              yes = "university of maryland, college park", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(ohio state university|ohio state university$|^ohio state|osu)\\b"),
                              yes = "ohio state university, columbus", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(university of tsukuba|universityof tsukuba)\\b"),
                              yes = "tsukuba university", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(university at buffalo|^state university of new york$|^suny$)\\b"),
                              yes = "state university of new york at buffalo", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(technical university of munich|tu munich)\\b"),
                              yes = "technische universität münchen", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(university of freiburg|albert ludwig university of freiburg|albert-ludwigs-universitt freiburg|uni freiburg|freiburg university|albert ludwig university freiburg|university freiburg|universitt freiburg)\\b"),
                              yes = "albert-ludwigs-universität freiburg", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(washington university in st louis|washington university in st. louis|washington university in saint louis|washington university at st. louis)\\b"),
                              yes = "washington university, saint louis", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)((?<!it )university of copenhagen)\\b"),
                              yes = "copenhagen university", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(ghent university|ugent)\\b"),
                              yes = "universiteit gent", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(newcastle university|university of newcastle)\\b"),
                              yes = "university of newcastle-upon-tyne", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(international institute of information technology hyderabad|iiit hyderabad|iiit-hyderabad)\\b"),
                              yes = "international institute of information technology, hyderabad", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(epfl)\\b"),
                              yes = "epfl - epf lausanne", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(uestc)\\b"),
                              yes = "university of electronic science and technology of china", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(bupt)\\b"),
                              yes = "beijing university of posts and telecommunications", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(ustc)\\b"),
                              yes = "university of science and technology of china", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(kaist)\\b"),
                              yes = "korea advanced institute of science & technology", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(epitech)\\b"),
                              yes = "ecole pour l'informatique et les nouvelles technologies", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(mipt)\\b"),
                              yes = "moscow institute of physics and technology", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(hkust)\\b"),
                              yes = "hong kong university of science and technology", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(caltech)\\b"),
                              yes = "california institute technology", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(scut)\\b"),
                              yes = "south china university of technology", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(unicamp)\\b"),
                              yes = "universidade estadual de campinas", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(feup)\\b"),
                              yes = "universidade do porto", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(king's college london)\\b"),
                              yes = "king's college london, university of london", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(karlsruhe institute of technology)\\b"),
                              yes = "karlsruher institut für technologie", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(nus)\\b"),
                              yes = "national university of singapore", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(ntnu)\\b"),
                              yes = "norwegian university of science and technology", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(tu berlin|technische universitat berlin)\\b"),
                              yes = "technische universität berlin", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(tu darmstadt|technische universitat darmstadt)\\b"),
                              yes = "technische universität darmstadt", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(kth)\\b"),
                              yes = "kth royal institute of technology", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(umass amherst)\\b"),
                              yes = "university of massachusetts at amherst", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(pku)\\b"),
                              yes = "peking university", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(nc state university)\\b"),
                              yes = "north carolina state university", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(technische universitt mnchen|tu munchen|tu münchen|tum)\\b"),
                              yes = "technische universität münchen", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(ufmg)\\b"),
                              yes = "universidade federal de minas gerais", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(university of so paulo|university of sao paulo)\\b"),
                              yes = "universidade de são paulo", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(linkping university|linkoping university)\\b"),
                              yes = "linköping university", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(university of stuttgart)\\b"),
                              yes = "universität stuttgart", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(ecnu)\\b"),
                              yes = "east china normal university", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(universidade de brasilia|universidade de braslia)\\b"),
                              yes = "universidade de brasília", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(university of hawaii)\\b"),
                              yes = "university of hawaii system", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(trinity college dublin)\\b"),
                              yes = "university of dublin, trinity college", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(cuhk)\\b"),
                              yes = "chinese university of hong kong", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(tu wien)\\b"),
                              yes = "technische universität wien", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(bits pilani)\\b"),
                              yes = "birla institute of technology and science", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(hasso plattner institut|hasso-plattner-institute|hasso-plattner-institut|hasso-plattner institut|hasso plattner institute)\\b"),
                              yes = "hasso plattner institute", no = organization)) %>%
  dt_mutate(organization = ifelse(test = str_detect(string = organization, 
                              pattern = "\\b(?i)(whu)\\b"),
                              yes = "wissenschaftliche hochschule für unternehmensführung, otto-beisheim hochschule", no = organization))

# create a frequency table
org_counts <- orgs_clean %>% group_by(organization) %>% count() %>% arrange(-n) 

# compare with hipo labs dataset to pull out academic institutions
institutions_hipolabs <- institutions_hipolabs %>% as.data.table() %>% dt_mutate(institution = str_to_lower(institution))
overlap <- semi_join(org_counts, institutions_hipolabs, by = c("organization" = "institution"))
sum(overlap[,"n"])
sum(filter(overlap, organization != "misc. student")[,"n"])
filter(overlap, organization == "misc. student")$n

# make a table to see what isn't caught by hipo labs
leftover <- anti_join(org_counts, overlap)
```

At this point, we have 28,641 users in the academic sector: 27,077 matched to academic institutions and 1,564 identified as misc. students.

We can boost this number by looking at the users' email domains.

```{r domains_recode}
# get just the domains from the emails
email_domains <- users_gh %>% drop_na(email) %>%
dt_mutate(domains = str_replace_all(email, "^[a-zA-Z0-9_.+-]+@", ""))

# match academic institutions from hipolabs to users based on email domains
# only impute company when it was NA
imputed_institutions <- email_domains %>%
  as.data.table() %>%
  inner_join(drop_na(institutions_hipolabs, domains)) %>%
  subset(is.na(company)) %>%
  dt_mutate(organization = institution)

nrow(imputed_institutions)
# 11,632 imputed

# join with other recoded data to update academic counts
orgs_clean <- full_join(orgs_clean, imputed_institutions[,c("login","email","organization")])
org_counts <- orgs_clean %>% group_by(organization) %>% count() %>% arrange(-n) 
overlap <- semi_join(org_counts, institutions_hipolabs, by = c("organization" = "institution"))
sum(overlap[,"n"])
```

New total is 40,273 users in the academic sector.

At this point, we can make a table of users in the academic sector to push to our database.

```{r final_table}
final_table <- orgs_clean %>%
  semi_join(institutions_hipolabs, by = c("organization" = "institution")) %>%
  transmute(login = login, company_raw = company, company_cleaned = organization, is_academic = 1)
```

Now that we have the counts for GitHub users at academic institutions, we'd like to recombine this with the Hipo Labs data to get the country locations for these institutions.

```{r get_countries}
# rejoin with hipo labs data
academic_counts <- overlap %>%
  left_join(institutions_hipolabs, by = c("organization" = "institution")) %>% 
  filter(!(organization == "misc. student")) # remove misc. students for future analyses

sum(academic_counts[,"n"]) 
# now there are 42,966 users?
# larger than before because it's double-counting the institutions that are in multiple countries or have multiple domains

# group together different country and domain values for the same institution
group1 <- academic_counts[duplicated(academic_counts$organization), ] %>% rename(c(country2 = country, domains2 = domains))
group2 <- group1[duplicated(group1$organization), ] %>% rename(c(country3 = country2, domains3 = domains2))
group3 <- group2[duplicated(group2$organization), ] %>% rename(c(country4 = country3, domains4 = domains3))
group4 <- group3[duplicated(group3$organization), ] %>% rename(c(country5 = country4, domains5 = domains4))

# remove duplicates so each group has unique values
group1 <- group1[!duplicated(group1$organization), ]
group2 <- group2[!duplicated(group2$organization), ]
group3 <- group3[!duplicated(group3$organization), ]
group4 <- group4[!duplicated(group4$organization), ]

# add back in the multiple countries/domains, but as additional columns
# now there is only one row for each institution
academic_counts <- academic_counts[!duplicated(academic_counts$organization), ] %>% 
  left_join(group1) %>%
  left_join(group2) %>%
  left_join(group3) %>%
  left_join(group4)

# add NAs for when multiple country listings are the same (if the duplicated institution is from multiple domains)
# or when multiple domain listings are the same (if the duplicated institution is from multiple countries)
academic_counts <- academic_counts %>%
  mutate_all(str_replace_na) %>%
  dt_mutate(country2 = if_else(country == country2, "NA", country2)) %>%
  dt_mutate(country3 = if_else(country == country3, "NA", country3)) %>%
  dt_mutate(domains2 = if_else(domains == domains2, "NA", domains2)) %>%
  dt_mutate(domains3 = if_else(domains == domains3, "NA", domains3)) %>%
  dt_mutate(domains4 = if_else(domains == domains4, "NA", domains4)) %>%
  dt_mutate(domains5 = if_else(domains == domains5, "NA", domains5))

# collapse into single columns for country/domains
# we want to avoid having multiple countries for an institution, since they'd be double-counted in the following analyses
# for the 21 institutions represented that are in multiple countries, the primary country is manually coded
academic_counts <- academic_counts %>%
  dt_mutate(country = if_else(condition = organization %chin% c("universidad simón bolivar", "suleyman demirel university", "universidad de córdoba", "aga khan university", "southeast university", "universidad de los andes", "korea university"), true = country2, false = country)) %>%
  dt_mutate(domains_combined = str_c(domains, domains2, domains3, domains4, domains5, sep = ", ")) %>%
  transmute(organization = organization, n = n, country = country, domains = domains_combined)

# remove remaining NAs
academic_counts <- academic_counts %>% 
  dt_mutate(domains = str_replace_all(domains, ", NA", "")) %>%
  dt_mutate(n = as.numeric(n)) # for some reason n got changed to chr type
```

Create nodelist for network analysis

```{r}
academic_institution_nodelist <- academic_counts %>%
  select(-domains) %>%
  rename(Id = organization)

write_csv(academic_institution_nodelist, "academic_institution_nodelist_gephi.csv")
```

Now let's look at some statistics.

```{r stats}
length(filter(academic_counts, country == "United States")$organization) / length(academic_counts$organization)
# 33% of academic institutions represented are in the U.S.
sum(filter(academic_counts, country == "United States")[, "n"]) / sum(academic_counts[, "n"])
# 55% of users in the academic sector are at U.S. institutions
sum(academic_counts[,"n"]) / 2435698
# 1.6% of all users have been matched to an academic institution

# look at percentage of academic sector users in each country
options(scipen = 10)
country_user_percentages <- academic_counts %>% group_by(country) %>% select(country, n) %>% summarise(n = sum(n) / sum(academic_counts[, "n"])) %>% arrange(-n)
country_user_percentages
```

Finally, let's plot some of this stuff.

```{r, top_ten, fig.width = 12}
academic_counts_sorted <- academic_counts %>% 
  arrange(n) %>%
  dt_mutate(organization = factor(organization, levels = organization))

ggplot(data = academic_counts_sorted[(.N-10):.N,]) + 
  geom_col(mapping = aes(organization, n, fill = n)) + 
  labs(x = "Academic institution", 
       y = "User count", 
       title = "Top 10 universities by users") + 
  coord_flip() +
  theme_minimal()
```

```{r, by_country, fig.height = 7, fig.width = 12}
ggplot(academic_counts_sorted[(.N-20):.N, ], aes(color = country)) +
  geom_point(aes(x = organization, y = n), size = 4) +
  geom_segment(data = academic_counts_sorted[(.N-20):.N, ], mapping = aes(x = organization, xend = organization, y = 0, yend = n), size = 1) +
  scale_color_manual(values = c("United States" = "#485C99", "China" = "#E57200", "Canada" = "#12B2CE")) +
  labs(x = "Academic Institution", y = "Number of Users", color = "Country", title = "Top 20 universities by number of users") +
  #theme_classic() +
  theme(axis.text.y = element_text(size = 12)) +
  coord_flip() +
  theme_minimal()
```

```{r, us_universities, fig.height=7}
us_academic_counts <- academic_counts_sorted %>% filter(country == "United States")

ggplot(us_academic_counts[(.N-20):.N, ]) +
  geom_point(aes(x = organization, y = n)) +
  geom_segment(data = us_academic_counts[(.N-20):.N, ], mapping = aes(x = organization, xend = organization, y = 0, yend = n)) +
  labs(x = "Academic Institution", y = "Number of Users", title = "Top 20 universities in the United States") +
  theme_classic() +
  coord_flip()
```

```{r, countries_users, fig.height=7}
#country_frequency_institutions <- academic_counts %>% group_by(country) %>% count(wt = n(), sort = TRUE)

country_frequency_users <- academic_counts %>% group_by(country) %>% count(sort = TRUE, wt = n)
country_users_sorted <- country_frequency_users %>%
  arrange(n) %>%
  dt_mutate(country = factor(country, levels = country))

ggplot(country_users_sorted[(.N-20):.N, ]) +
  geom_point(aes(x = country, y = n)) +
  geom_segment(data = country_users_sorted[(.N-20):.N, ], mapping = aes(x = country, xend = country, y = 0, yend = n)) +
  labs(x = "Country", y = "Number of Users", title = "Top 20 countries by users in the academic sector") +
  theme_classic() +
  scale_y_log10() +
  coord_flip()
```

```{r}
# connect to postgresql to get data (in rivanna)
conn <- dbConnect(drv = PostgreSQL(), 
 dbname = "sdad", 
 host = "10.250.124.195", 
 port = 5432, 
 user = Sys.getenv("db_userid"), 
 password = Sys.getenv("db_pwd"))
dbWriteTable(conn, c("gh", "sna_ctr_academic"), final_table, row.names = FALSE)
# disconnect from postgresql database 
dbDisconnect(conn)
```
